<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civic Issue Reporting System - Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select, button {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .success {
            color: green;
            background-color: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            color: red;
            background-color: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background-color: #e7f3ff;
        }
        .issue-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .hidden {
            display: none;
        }
        .notification-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
        }
        .notification-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease-out;
        }
        .notification-item.success {
            border-left: 4px solid #28a745;
        }
        .notification-item.info {
            border-left: 4px solid #17a2b8;
        }
        .notification-item.warning {
            border-left: 4px solid #ffc107;
        }
        .notification-item.error {
            border-left: 4px solid #dc3545;
        }
        .notification-header {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .notification-time {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        .notification-close {
            float: right;
            cursor: pointer;
            color: #6c757d;
            font-weight: bold;
        }
        .notification-close:hover {
            color: #dc3545;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .notification-bell {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1001;
        }
        .notification-bell:hover {
            background: #0056b3;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- Notification Bell -->
    <button class="notification-bell" onclick="toggleNotifications()" id="notification-bell">
        üîî
        <span class="notification-badge hidden" id="notification-badge">0</span>
    </button>

    <!-- Notification Panel -->
    <div class="notification-panel hidden" id="notification-panel">
        <div style="background: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 2px solid #007bff;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <strong>üì¢ Notifications</strong>
                <button onclick="clearAllNotifications()" style="background: none; border: none; color: #dc3545; cursor: pointer;">Clear All</button>
            </div>
        </div>
        <div id="notifications-list"></div>
    </div>

    <h1>üèôÔ∏è Civic Issue Reporting System</h1>

    <div class="status" id="status">
        <strong>Backend Status:</strong> <span id="backend-status">Checking...</span>
        <span style="margin-left: 20px;">
            <strong>Real-time Status:</strong> <span id="realtime-status">üü° Connecting...</span>
        </span>
    </div>

    <!-- Login Section -->
    <div class="container" id="login-section">
        <h2>üîê Login</h2>
        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" value="admin@civicreport.com">
        </div>
        <div class="form-group">
            <label for="password">Password:</label>
            <input type="password" id="password" value="admin123">
        </div>
        <button onclick="login()">Login</button>
        <div id="login-message"></div>
    </div>

    <!-- Main App Section -->
    <div class="container hidden" id="app-section">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h2>Welcome, <span id="user-name"></span>!</h2>
                <div id="user-role-badge" style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px;"></div>
            </div>
            <div>
                <button onclick="openStaffDashboard()" style="margin-right: 10px; background-color: #6c757d;">Staff Dashboard</button>
                <button onclick="logout()">Logout</button>
            </div>
        </div>
        
        <!-- Report Issue Section -->
        <div class="container">
            <h3>üìù Report New Issue</h3>
            <div class="form-group">
                <label for="title">Title:</label>
                <input type="text" id="title" placeholder="Brief description of the issue">
            </div>
            <div class="form-group">
                <label for="description">Description:</label>
                <textarea id="description" rows="4" placeholder="Detailed description of the issue"></textarea>
            </div>
            <div class="form-group">
                <label for="category">Category:</label>
                <select id="category">
                    <option value="Road">Road</option>
                    <option value="Water">Water</option>
                    <option value="Electricity">Electricity</option>
                    <option value="Waste">Waste</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label for="address">Address:</label>
                <input type="text" id="address" placeholder="Location of the issue">
            </div>
            <button onclick="reportIssue()">Submit Report</button>
            <div id="report-message"></div>
        </div>

        <!-- Issues List Section -->
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 id="issues-title">üìã All Issues</h3>
                <div>
                    <button onclick="loadIssues()">Refresh Issues</button>
                    <div id="real-time-indicator" style="display: inline-block; margin-left: 10px; font-size: 12px;"></div>
                </div>
            </div>
            <div id="issues-list"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000';
        let authToken = null;
        let currentUser = null;
        let socket = null;
        let notifications = [];
        let notificationCount = 0;

        // Notification functions
        function addNotification(title, message, type = 'info') {
            const notification = {
                id: Date.now(),
                title,
                message,
                type,
                timestamp: new Date()
            };

            notifications.unshift(notification);
            notificationCount++;

            updateNotificationBadge();
            updateNotificationsList();

            // Auto-remove after 10 seconds if panel is not open
            setTimeout(() => {
                if (document.getElementById('notification-panel').classList.contains('hidden')) {
                    removeNotification(notification.id);
                }
            }, 10000);
        }

        function removeNotification(id) {
            notifications = notifications.filter(n => n.id !== id);
            updateNotificationsList();
        }

        function clearAllNotifications() {
            notifications = [];
            notificationCount = 0;
            updateNotificationBadge();
            updateNotificationsList();
        }

        function toggleNotifications() {
            const panel = document.getElementById('notification-panel');
            panel.classList.toggle('hidden');

            if (!panel.classList.contains('hidden')) {
                // Mark as read when opened
                notificationCount = 0;
                updateNotificationBadge();
            }
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notification-badge');
            if (notificationCount > 0) {
                badge.textContent = notificationCount > 99 ? '99+' : notificationCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function updateNotificationsList() {
            const list = document.getElementById('notifications-list');

            if (notifications.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 20px;">No notifications</div>';
                return;
            }

            list.innerHTML = notifications.map(notification => `
                <div class="notification-item ${notification.type}">
                    <span class="notification-close" onclick="removeNotification(${notification.id})">√ó</span>
                    <div class="notification-header">${notification.title}</div>
                    <div>${notification.message}</div>
                    <div class="notification-time">${notification.timestamp.toLocaleString()}</div>
                </div>
            `).join('');
        }

        // Check backend status
        async function checkBackendStatus() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                document.getElementById('backend-status').innerHTML = 
                    `‚úÖ Connected - ${data.collections.users} users, ${data.collections.issues} issues`;
            } catch (error) {
                document.getElementById('backend-status').innerHTML = 
                    `‚ùå Backend not running on ${API_BASE}`;
            }
        }

        // Login function
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.access_token;
                    currentUser = data.user;
                    document.getElementById('user-name').textContent = currentUser.name;

                    // Set role badge
                    const roleBadge = document.getElementById('user-role-badge');
                    if (currentUser.role === 'admin') {
                        roleBadge.textContent = 'üëë ADMIN';
                        roleBadge.style.backgroundColor = '#dc3545';
                        roleBadge.style.color = 'white';
                    } else {
                        roleBadge.textContent = 'üë§ USER';
                        roleBadge.style.backgroundColor = '#007bff';
                        roleBadge.style.color = 'white';
                    }

                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('app-section').classList.remove('hidden');
                    document.getElementById('login-message').innerHTML =
                        '<div class="success">Login successful!</div>';

                    // Update issues title based on role
                    if (currentUser.role === 'admin') {
                        document.getElementById('issues-title').innerHTML = 'üëë All Issues (Admin View - Can Update Status)';
                    } else if (currentUser.role === 'staff') {
                        document.getElementById('issues-title').innerHTML = `üë∑ ${currentUser.category || 'Staff'} Issues (Staff View - Can Update Status)`;
                    } else {
                        document.getElementById('issues-title').innerHTML = 'üìã Community Issues';
                    }

                    loadIssues();

                    // Reinitialize WebSocket with user context
                    if (socket) {
                        socket.disconnect();
                    }
                    initializeWebSocket();
                } else {
                    document.getElementById('login-message').innerHTML =
                        `<div class="error">${data.error}</div>`;
                }
            } catch (error) {
                document.getElementById('login-message').innerHTML = 
                    `<div class="error">Connection error: ${error.message}</div>`;
            }
        }

        // Logout function
        function logout() {
            authToken = null;
            currentUser = null;
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('app-section').classList.add('hidden');
        }

        // Report issue function
        async function reportIssue() {
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const category = document.getElementById('category').value;
            const address = document.getElementById('address').value;
            
            if (!title || !description) {
                document.getElementById('report-message').innerHTML = 
                    '<div class="error">Please fill in title and description</div>';
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('title', title);
                formData.append('description', description);
                formData.append('category', category);
                formData.append('address', address);
                
                const response = await fetch(`${API_BASE}/report`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('report-message').innerHTML = 
                        '<div class="success">Issue reported successfully!</div>';
                    // Clear form
                    document.getElementById('title').value = '';
                    document.getElementById('description').value = '';
                    document.getElementById('address').value = '';
                    loadIssues();
                } else {
                    document.getElementById('report-message').innerHTML = 
                        `<div class="error">${data.error}</div>`;
                }
            } catch (error) {
                document.getElementById('report-message').innerHTML = 
                    `<div class="error">Connection error: ${error.message}</div>`;
            }
        }

        // Load issues function with admin capabilities
        async function loadIssues() {
            try {
                let endpoint = `${API_BASE}/issues`;
                let headers = {};

                // If user is admin, use admin endpoint to get all issues
                if (currentUser && currentUser.role === 'admin') {
                    endpoint = `${API_BASE}/admin/reports`;
                    headers = {'Authorization': `Bearer ${authToken}`};
                }

                const response = await fetch(endpoint, { headers });
                const data = await response.json();

                if (response.ok) {
                    updateRealTimeIndicator('connected');
                    const issuesList = document.getElementById('issues-list');
                    if (data.issues.length === 0) {
                        issuesList.innerHTML = '<p>No issues reported yet.</p>';
                    } else {
                        issuesList.innerHTML = data.issues.map(issue => `
                            <div class="issue-card">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <h4>${issue.title}</h4>
                                    <span class="status-badge" style="background: ${getStatusColor(issue.status)}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                        ${issue.status}
                                    </span>
                                </div>
                                <p><strong>Category:</strong> ${issue.category}</p>
                                <p><strong>Description:</strong> ${issue.description}</p>
                                <p><strong>Location:</strong> ${issue.location.address || 'Not specified'}</p>
                                <p><strong>Reported by:</strong> ${issue.user_name} ${issue.user_email ? `(${issue.user_email})` : ''}</p>
                                <p><strong>Date:</strong> ${new Date(issue.created_at).toLocaleString()}</p>

                                ${currentUser && currentUser.role === 'admin' ? `
                                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                                        <label><strong>Update Status (Email will be sent to user):</strong></label>
                                        <select id="status-${issue._id}" onchange="updateIssueStatusAsAdmin('${issue._id}')" style="margin-left: 10px;">
                                            <option value="Pending" ${issue.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                            <option value="In Progress" ${issue.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                            <option value="Resolved" ${issue.status === 'Resolved' ? 'selected' : ''}>Resolved</option>
                                        </select>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                updateRealTimeIndicator('error');
                document.getElementById('issues-list').innerHTML =
                    `<div class="error">Error loading issues: ${error.message}</div>`;
            }
        }

        // Get status color
        function getStatusColor(status) {
            switch(status) {
                case 'Pending': return '#ffc107';
                case 'In Progress': return '#007bff';
                case 'Resolved': return '#28a745';
                default: return '#6c757d';
            }
        }

        // Admin function to update issue status
        async function updateIssueStatusAsAdmin(issueId) {
            const newStatus = document.getElementById(`status-${issueId}`).value;

            try {
                const response = await fetch(`${API_BASE}/admin/update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        issue_id: issueId,
                        status: newStatus
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`‚úÖ Status updated to "${newStatus}" successfully!\nüìß Email notification sent to the user automatically.`);
                    loadIssues(); // Refresh the list
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                    loadIssues(); // Reset
                }
            } catch (error) {
                alert(`‚ùå Connection error: ${error.message}`);
                loadIssues(); // Reset
            }
        }

        // Open staff dashboard
        function openStaffDashboard() {
            window.open('staff_dashboard.html', '_blank');
        }

        // Update real-time indicator
        function updateRealTimeIndicator(status) {
            const indicator = document.getElementById('real-time-indicator');
            if (status === 'connected') {
                indicator.innerHTML = '<span style="color: green;">üü¢ Real-time updates active</span>';
            } else {
                indicator.innerHTML = '<span style="color: red;">üî¥ Connection error</span>';
            }
        }

        // WebSocket connection for real-time updates

        function initializeWebSocket() {
            try {
                socket = io('http://localhost:5000');

                socket.on('connect', function() {
                    console.log('Connected to WebSocket server');
                    updateRealTimeIndicator('connected');

                    // Join appropriate room based on user role
                    if (authToken && currentUser) {
                        if (currentUser.role === 'admin') {
                            socket.emit('join_room', {room: 'admins'});
                        } else if (currentUser.role === 'staff') {
                            socket.emit('join_room', {room: 'staff'});
                        } else {
                            socket.emit('join_room', {room: `user_${currentUser.id}`});
                        }
                    }
                });

                socket.on('disconnect', function() {
                    console.log('Disconnected from WebSocket server');
                    updateRealTimeIndicator('error');
                });

                socket.on('status_update', function(data) {
                    console.log('Status update received:', data);
                    // Refresh issues list when status updates occur
                    loadIssues();

                    // Show notification for admin/staff
                    if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'staff')) {
                        addNotification(
                            'üìß Status Updated',
                            `Issue "${data.title}" status changed to ${data.status}. Email sent to user.`,
                            'success'
                        );
                    }
                });

                // Listen for user notifications (when staff/admin updates their issues)
                socket.on('user_notification', function(data) {
                    console.log('User notification received:', data);

                    // Check if this notification is for the current user
                    if (currentUser && (
                        currentUser.role === 'user' &&
                        (data.user_id === currentUser.id || !data.user_id)
                    )) {
                        addNotification(
                            'üîÑ Issue Status Update',
                            `Your issue "${data.title}" status has been updated to: ${data.status} by ${data.updated_by}`,
                            'success'
                        );

                        // Refresh issues list
                        loadIssues();
                    }
                });

                socket.on('new_issue', function(data) {
                    console.log('New issue notification received:', data);

                    // Show notification for admin/staff about new issues
                    if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'staff')) {
                        addNotification(
                            'üÜï New Issue Reported',
                            `New ${data.category} issue: "${data.title}" reported by ${data.user_name}`,
                            'info'
                        );

                        // Refresh issues list
                        loadIssues();
                        alert(`üìß Issue Updated: "${data.title}" is now ${data.status}`);
                    }
                });

                socket.on('notification', function(data) {
                    console.log('Notification received:', data);

                    if (data.type === 'new_issue') {
                        // Refresh issues list when new issues are reported
                        loadIssues();

                        // Show notification for admin
                        if (currentUser && currentUser.role === 'admin') {
                            alert(`üÜï New Issue: ${data.message}`);
                        }
                    } else if (data.type === 'issue_status') {
                        // User notification about their issue status change
                        alert(`üìß ${data.title}: ${data.message}`);
                        loadIssues(); // Refresh to show updated status
                    }
                });

            } catch (error) {
                console.error('WebSocket connection failed:', error);
                updateRealTimeIndicator('error');
            }
        }

        // Initialize
        checkBackendStatus();
        setInterval(checkBackendStatus, 30000); // Check every 30 seconds

        // Initialize WebSocket for real-time updates
        initializeWebSocket();
    </script>
</body>
</html>
